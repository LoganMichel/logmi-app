<div class="links-page">
  <div class="page-header">
    <div>
      <h1>Mes liens Linktree</h1>
      <p>Gérez les liens de votre page Linktree</p>
    </div>
    <div class="header-actions">
      <a [href]="linktreeUrl + '/' + username + '/links/'" target="_blank" class="btn-secondary">
        <span class="material-icon">visibility</span>
        Voir ma page
      </a>
      <button class="btn-primary" (click)="openModal()">
        <span class="material-icon">add</span>
        Ajouter
      </button>
    </div>
  </div>

  @if (message(); as msg) {
    <div
      class="message"
      [class.success]="msg.type === 'success'"
      [class.error]="msg.type === 'error'"
    >
      <span class="material-icon">{{ msg.type === 'success' ? 'check_circle' : 'error' }}</span>
      {{ msg.text }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      Chargement...
    </div>
  } @else if (links().length === 0) {
    <div class="empty-state">
      <span class="empty-icon material-icon">link</span>
      <h3>Aucun lien</h3>
      <p>Ajoutez votre premier lien pour créer votre Linktree</p>
      <button class="btn-primary" (click)="openModal()">Ajouter un lien</button>
    </div>
  } @else {
    <div class="links-list">
      @for (link of links(); track link.id; let i = $index) {
        <div
          class="link-card"
          [class.inactive]="!link.is_active"
          [class.dragging]="draggedIndex() === i"
          [class.drag-over]="dragOverIndex() === i"
          draggable="true"
          (dragstart)="onDragStart($event, i)"
          (dragend)="onDragEnd()"
          (dragover)="onDragOver($event, i)"
          (dragleave)="onDragLeave()"
          (drop)="onDrop($event, i)"
        >
          <div class="link-drag">
            <span class="material-icon">drag_indicator</span>
          </div>
          <div class="link-content">
            <div class="link-header">
              @if (link.icon) {
                @if (link.icon.includes('fa-')) {
                  <i [class]="link.icon + ' link-icon'"></i>
                } @else {
                  <span class="material-icon link-icon">{{ link.icon }}</span>
                }
              }
              <h3>{{ link.name }}</h3>
              <span class="link-status" [class.active]="link.is_active">
                {{ link.is_active ? 'Actif' : 'Inactif' }}
              </span>
            </div>
            <a [href]="link.url" target="_blank" class="link-url">{{ link.url }}</a>
            <div class="link-stats">
              <span
                ><span class="material-icon stat-icon-small">bar_chart</span>
                {{ link.total_clicks }} clics</span
              >
              <span
                ><span class="material-icon stat-icon-small">qr_code</span>
                {{ link.qrcode_clicks }} via QR</span
              >
            </div>
          </div>
          <div class="link-actions">
            <button
              class="icon-btn"
              (click)="toggleActive(link)"
              [title]="link.is_active ? 'Désactiver' : 'Activer'"
            >
              <span class="material-icon">{{ link.is_active ? 'toggle_on' : 'toggle_off' }}</span>
            </button>
            <button class="icon-btn" (click)="openModal(link)" title="Modifier">
              <span class="material-icon">edit</span>
            </button>
            <button class="icon-btn danger" (click)="deleteLink(link)" title="Supprimer">
              <span class="material-icon">delete</span>
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>

@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingLink() ? 'Modifier le lien' : 'Nouveau lien' }}</h2>
        <button class="close-btn" (click)="closeModal()">
          <span class="material-icon">close</span>
        </button>
      </div>
      <form (ngSubmit)="saveLink()" class="modal-form">
        <div class="form-group">
          <label for="name">Nom du lien *</label>
          <input
            type="text"
            id="name"
            [ngModel]="name()"
            (ngModelChange)="name.set($event)"
            name="name"
            placeholder="Mon Portfolio"
            required
          />
        </div>
        <div class="form-group">
          <label for="url">URL *</label>
          <input
            type="url"
            id="url"
            [ngModel]="url()"
            (ngModelChange)="url.set($event)"
            name="url"
            placeholder="https://example.com"
            required
          />
        </div>
        <div class="form-group">
          <label for="icon">Icône</label>
          <div class="icon-selector">
            <div class="icon-presets">
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-linkedin'"
                (click)="icon.set('fa-brands fa-linkedin')"
                title="LinkedIn"
              >
                <i class="fa-brands fa-linkedin"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-facebook'"
                (click)="icon.set('fa-brands fa-facebook')"
                title="Facebook"
              >
                <i class="fa-brands fa-facebook"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-instagram'"
                (click)="icon.set('fa-brands fa-instagram')"
                title="Instagram"
              >
                <i class="fa-brands fa-instagram"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-x-twitter'"
                (click)="icon.set('fa-brands fa-x-twitter')"
                title="X (Twitter)"
              >
                <i class="fa-brands fa-x-twitter"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-youtube'"
                (click)="icon.set('fa-brands fa-youtube')"
                title="YouTube"
              >
                <i class="fa-brands fa-youtube"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-tiktok'"
                (click)="icon.set('fa-brands fa-tiktok')"
                title="TikTok"
              >
                <i class="fa-brands fa-tiktok"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-github'"
                (click)="icon.set('fa-brands fa-github')"
                title="GitHub"
              >
                <i class="fa-brands fa-github"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-discord'"
                (click)="icon.set('fa-brands fa-discord')"
                title="Discord"
              >
                <i class="fa-brands fa-discord"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-twitch'"
                (click)="icon.set('fa-brands fa-twitch')"
                title="Twitch"
              >
                <i class="fa-brands fa-twitch"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-spotify'"
                (click)="icon.set('fa-brands fa-spotify')"
                title="Spotify"
              >
                <i class="fa-brands fa-spotify"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-whatsapp'"
                (click)="icon.set('fa-brands fa-whatsapp')"
                title="WhatsApp"
              >
                <i class="fa-brands fa-whatsapp"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-brands fa-telegram'"
                (click)="icon.set('fa-brands fa-telegram')"
                title="Telegram"
              >
                <i class="fa-brands fa-telegram"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-solid fa-globe'"
                (click)="icon.set('fa-solid fa-globe')"
                title="Site web"
              >
                <i class="fa-solid fa-globe"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === 'fa-solid fa-envelope'"
                (click)="icon.set('fa-solid fa-envelope')"
                title="Email"
              >
                <i class="fa-solid fa-envelope"></i>
              </button>
              <button
                type="button"
                class="icon-btn-preset"
                [class.selected]="icon() === ''"
                (click)="icon.set('')"
                title="Aucune icône"
              >
                <span class="material-icon">close</span>
              </button>
            </div>
            <input
              type="text"
              id="icon"
              [ngModel]="icon()"
              (ngModelChange)="icon.set($event)"
              name="icon"
              placeholder="Ou saisir: link, public, home..."
              class="icon-input"
            />
          </div>
        </div>
        <div class="form-group checkbox-group">
          <input
            type="checkbox"
            id="isActive"
            [ngModel]="isActive()"
            (ngModelChange)="isActive.set($event)"
            name="isActive"
          />
          <label for="isActive">Lien actif</label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeModal()">Annuler</button>
          <button type="submit" class="btn-primary" [disabled]="isSaving()">
            @if (isSaving()) {
              <span class="spinner"></span>
            }
            {{ editingLink() ? 'Modifier' : 'Créer' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}
